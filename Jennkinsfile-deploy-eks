pipeline {
  agent any
  environment {
    AWS_REGION = 'ap-southeast-1'
    CLUSTER_NAME  = 'preecr-cluster'
    DEPLOY_PATH   = 'k8s'
  }

  stages {
    stage('Deploy to EKS') {
      steps {
        withCredentials([
          usernamePassword(credentialsId: 'aws-credentials', usernameVariable: 'AWS_ACCESS_KEY_ID', passwordVariable: 'AWS_SECRET_ACCESS_KEY')
        ]) {
          sh '''
            echo "===> Configuring kubeconfig for EKS"
            export AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID
            export AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY

            aws eks update-kubeconfig --region $AWS_REGION --name $CLUSTER_NAME

            echo "===> Deploying Kubernetes manifests"
            kubectl apply -f $DEPLOY_PATH/deployment.yaml
            kubectl apply -f $DEPLOY_PATH/service.yaml
          '''
        }
      }
    }
}
}