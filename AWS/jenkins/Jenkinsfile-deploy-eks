pipeline {
  agent any
  environment {
    DEPLOY_PATH   = 'k8s'
  }

  stages {
    stage('Deploy to EKS') {
      steps {
        withCredentials([
          usernamePassword(credentialsId: 'aws-credentials', usernameVariable: 'AWS_ACCESS_KEY_ID', passwordVariable: 'AWS_SECRET_ACCESS_KEY')
        ]) {
          sh '''
  echo "===> Updating kubeconfig"
  export AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID
  export AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY

  aws eks update-kubeconfig \
    --region ap-southeast-1 \
    --name my-eks-cluster \
    --alias my-eks-cluster

  echo "===> Testing access"
  aws sts get-caller-identity

  echo "===> Deploying Kubernetes manifests"
  export KUBECONFIG=$HOME/.kube/config
  kubectl get nodes
  kubectl apply -f $DEPLOY_PATH/deployment.yaml
'''

          // aws sts get-caller-identity
        }
      }
    }
}
}