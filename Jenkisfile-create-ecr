pipeline {
  agent any

  parameters {
    string(name: 'ECR_REPO_NAME', defaultValue: 'preecr', description: 'Name of the ECR repository to create')
  }
  environment {
    AWS_REGION    = 'ap-southeast-1'
    ECR_REPO_NAME = "${params.ECR_REPO_NAME}"
  }

  stages {
    stage('Terraform Init & Apply (Create ECR)') {
      steps {
        dir('terraform-ecr') {
          withCredentials([
            usernamePassword(
              credentialsId: 'aws-credentials',
              usernameVariable: 'AWS_ACCESS_KEY_ID',
              passwordVariable: 'AWS_SECRET_ACCESS_KEY'
            )
          ]) {
            sh '''
                #!/bin/bash
                echo "===> START Terraform Apply"

                export AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID
                export AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY

                terraform init
                terraform plan
                terraform apply -auto-approve \
                  -var="repository_name=$ECR_REPO_NAME" \
                  -var="lifecycle_policy=lifecycle-policy.json"

                echo "===> DONE Terraform Apply"
              '''
          }
        }
      }
    }
    
  }
}
